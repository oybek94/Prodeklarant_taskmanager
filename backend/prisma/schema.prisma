generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Branch {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  tasks        Task[]
  transactions Transaction[]
  users        User[]
}

model User {
  id           Int           @id @default(autoincrement())
  name         String
  email        String        @unique
  phone        String?
  role         Role
  position     String?
  salary       Decimal?      @db.Decimal(12, 2)
  branchId     Int
  passwordHash String
  photoUrl     String?
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now())
  auditLogs    AuditLog[]
  kpiLogs      KpiLog[]
  tasks        Task[]        @relation("TaskCreatedBy")
  taskErrors   TaskError[]
  stages       TaskStage[]   @relation("StageAssignedTo")
  transactions Transaction[] @relation("TransactionWorker")
  branch       Branch        @relation(fields: [branchId], references: [id])
}

model Client {
  id           Int           @id @default(autoincrement())
  name         String
  dealAmount   Decimal?      @db.Decimal(12, 2)
  phone        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  tasks        Task[]
  transactions Transaction[] @relation("TransactionClient")
}

model Task {
  id           Int           @id @default(autoincrement())
  clientId     Int
  branchId     Int
  title        String
  status       TaskStatus    @default(BOSHLANMAGAN)
  createdById  Int
  comments     String?
  hasPsr       Boolean       @default(false)
  driverPhone  String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  kpiLogs      KpiLog[]
  branch       Branch        @relation(fields: [branchId], references: [id])
  client       Client        @relation(fields: [clientId], references: [id])
  createdBy    User          @relation("TaskCreatedBy", fields: [createdById], references: [id])
  errors       TaskError[]
  stages       TaskStage[]
  transactions Transaction[]
}

model TaskStage {
  id           Int         @id @default(autoincrement())
  taskId       Int
  name         String
  stageOrder   Int
  status       StageStatus @default(BOSHLANMAGAN)
  startedAt    DateTime?
  completedAt  DateTime?
  assignedToId Int?
  durationMin  Int?
  price        Decimal?    @db.Decimal(12, 2)
  createdAt    DateTime    @default(now())
  assignedTo   User?       @relation("StageAssignedTo", fields: [assignedToId], references: [id])
  task         Task        @relation(fields: [taskId], references: [id])
}

model TaskError {
  id        Int      @id @default(autoincrement())
  taskId    Int
  stageName String
  workerId  Int
  amount    Decimal  @db.Decimal(12, 2)
  comment   String?
  date      DateTime
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id])
  worker    User     @relation(fields: [workerId], references: [id])
}

model Transaction {
  id              Int             @id @default(autoincrement())
  type            TransactionType
  amount          Decimal         @db.Decimal(12, 2)
  currency        String          @default("USD")
  comment         String?
  date            DateTime
  taskId          Int?
  clientId        Int?
  workerId        Int?
  expenseCategory String?
  branchId        Int?
  createdAt       DateTime        @default(now())
  branch          Branch?         @relation(fields: [branchId], references: [id])
  client          Client?         @relation("TransactionClient", fields: [clientId], references: [id])
  task            Task?           @relation(fields: [taskId], references: [id])
  worker          User?           @relation("TransactionWorker", fields: [workerId], references: [id])
}

model KpiConfig {
  id        Int      @id @default(autoincrement())
  stageName String   @unique
  price     Decimal  @default(0) @db.Decimal(12, 2)
  updatedAt DateTime @updatedAt
}

model KpiLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  taskId    Int
  stageName String
  amount    Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String
  entity    String
  entityId  Int?
  payload   Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

enum Role {
  ADMIN
  MANAGER
  WORKER
  ACCOUNTANT
}

enum TaskStatus {
  BOSHLANMAGAN
  JARAYONDA
  TAYYOR
}

enum StageStatus {
  BOSHLANMAGAN
  TAYYOR
}

enum TransactionType {
  INCOME
  EXPENSE
  SALARY
}

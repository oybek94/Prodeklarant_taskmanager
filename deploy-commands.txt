# Deployment Commands for Prodeklarant
# Execute these commands on the server (138.249.7.15) as root user

# Step 1: System Update
apt update && apt upgrade -y

# Step 2: Install Dependencies
apt install -y git curl build-essential nginx
curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
apt install -y nodejs
npm install -g pm2
curl -fsSL https://get.docker.com -o get-docker.sh && sh get-docker.sh && rm get-docker.sh
apt install -y docker-compose-plugin

# Step 3: Create Project Directory
mkdir -p /var/www/app
chown -R root:root /var/www/app

# Step 4: Clone Repository
cd /var/www/app
git clone https://github.com/oybek94/Prodeklarant_taskmanager .

# Step 5: Database Setup
docker-compose up -d db
sleep 10

# Step 6: Backend Configuration
cd /var/www/app/backend
cat > .env << 'EOF'
DATABASE_URL=postgresql://app:app@localhost:5432/prodeklarant
PORT=3001
NODE_ENV=production
JWT_SECRET=CHANGE_THIS_TO_STRONG_SECRET
JWT_REFRESH_SECRET=CHANGE_THIS_TO_STRONG_REFRESH_SECRET
OPENAI_API_KEY=
ALLOWED_ORIGINS=http://138.249.7.15,http://138.249.7.15:80
EOF

npm install
npm run prisma:generate
npx prisma migrate deploy
npm run build

# Step 7: Frontend Configuration
cd /var/www/app/frontend
cat > .env.production << 'EOF'
VITE_API_BASE_URL=http://138.249.7.15/api
EOF

npm install
npm run build

# Step 8: Start Backend with PM2
cd /var/www/app/backend
pm2 start ecosystem.config.js --env production
pm2 save
pm2 startup systemd

# Step 9: Configure Nginx
cat > /etc/nginx/sites-available/prodeklarant << 'NGINX_EOF'
server {
    listen 80;
    server_name 138.249.7.15;

    root /var/www/app/frontend/dist;
    index index.html;

    location /api {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    location /uploads {
        alias /var/www/app/backend/uploads;
    }

    location / {
        try_files $uri $uri/ /index.html;
    }
}
NGINX_EOF

ln -sf /etc/nginx/sites-available/prodeklarant /etc/nginx/sites-enabled/
rm -f /etc/nginx/sites-enabled/default
nginx -t
systemctl reload nginx

# Step 10: Firewall
ufw allow 80/tcp
ufw allow 443/tcp
ufw allow 22/tcp
ufw --force enable

# Step 11: Enable Services
systemctl enable nginx
systemctl enable docker

# Step 12: Verification
curl http://localhost:3001/health
curl http://localhost/
pm2 status
docker ps


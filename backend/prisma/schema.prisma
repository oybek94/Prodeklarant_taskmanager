generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Branch {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  invoices      Invoice[]
  statePayments StatePayment[]
  tasks         Task[]
  transactions  Transaction[]
  users         User[]
}

model User {
  id                Int                      @id @default(autoincrement())
  name              String
  email             String                   @unique
  phone             String?
  role              Role
  position          String?
  salary            Decimal?                 @db.Decimal(12, 2)
  branchId          Int?
  passwordHash      String
  photoUrl          String?
  active            Boolean                  @default(true)
  createdAt         DateTime                 @default(now())
  archiveDocuments  ArchiveDocument[]        @relation("ArchiveDocumentUploadedBy")
  auditLogs         AuditLog[]
  examAttempts      ExamAttempt[]
  kpiLogs           KpiLog[]
  lessonProgress    LessonProgress[]
  previousYearDebts PreviousYearWorkerDebt[] @relation("PreviousYearWorkerDebt")
  tasks             Task[]                   @relation("TaskCreatedBy")
  updatedTasks      Task[]                   @relation("TaskUpdatedBy")
  taskDocuments     TaskDocument[]           @relation("DocumentUploadedBy")
  taskErrors        TaskError[]              @relation("TaskErrorWorker")
  createdTaskErrors TaskError[]              @relation("TaskErrorCreatedBy")
  stages            TaskStage[]              @relation("StageAssignedTo")
  taskVersions      TaskVersion[]
  trainingProgress  TrainingProgress[]
  transactions      Transaction[]            @relation("TransactionWorker")
  branch            Branch?                  @relation(fields: [branchId], references: [id])
  workerPayments    WorkerPayment[]          @relation("WorkerPayment")
}

model Client {
  id                         Int             @id @default(autoincrement())
  name                       String
  dealAmount                 Decimal?        @db.Decimal(12, 2)
  dealAmountCurrency         Currency?       @default(USD)
  phone                      String?
  passwordHash               String?
  creditType                 String?
  creditLimit                Decimal?        @db.Decimal(12, 2)
  creditStartDate            DateTime?
  contractNumber             String?
  address                    String?
  inn                        String?
  email                      String?
  bankName                   String?
  bankAddress                String?
  bankAccount                String?
  transitAccount             String?
  bankSwift                  String?
  correspondentBank          String?
  correspondentBankAccount   String?
  correspondentBankSwift     String?
  createdAt                  DateTime        @default(now())
  updatedAt                  DateTime        @updatedAt
  dealAmountExchangeRate     Decimal?        @db.Decimal(18, 6)
  dealAmountInUzs            Decimal?        @db.Decimal(12, 2)
  dealAmount_amount_original Decimal?        @db.Decimal(14, 2)
  dealAmount_currency        Currency?
  dealAmount_exchange_rate   Decimal?        @db.Decimal(10, 4)
  dealAmount_amount_uzs      Decimal?        @db.Decimal(16, 2)
  dealAmount_exchange_source ExchangeSource?
  contracts                  Contract[]
  invoices                   Invoice[]
  tasks                      Task[]
  transactions               Transaction[]   @relation("TransactionClient")
}

model Task {
  id                                         Int                  @id @default(autoincrement())
  clientId                                   Int
  branchId                                   Int
  title                                      String
  status                                     TaskStatus           @default(BOSHLANMAGAN)
  createdById                                Int
  updatedById                                Int?
  comments                                   String?
  hasPsr                                     Boolean              @default(false)
  driverPhone                                String?
  snapshotDealAmount                         Decimal?             @db.Decimal(12, 2)
  snapshotCertificatePayment                 Decimal?             @db.Decimal(12, 2)
  snapshotPsrPrice                           Decimal?             @db.Decimal(12, 2)
  snapshotWorkerPrice                        Decimal?             @db.Decimal(12, 2)
  snapshotCustomsPayment                     Decimal?             @db.Decimal(12, 2)
  customsPaymentMultiplier                   Decimal?             @db.Decimal(5, 2)
  createdAt                                  DateTime             @default(now())
  updatedAt                                  DateTime             @updatedAt
  snapshotDealAmountExchangeRate             Decimal?             @db.Decimal(18, 6)
  snapshotCertificatePaymentExchangeRate     Decimal?             @db.Decimal(18, 6)
  snapshotPsrPriceExchangeRate               Decimal?             @db.Decimal(18, 6)
  snapshotWorkerPriceExchangeRate            Decimal?             @db.Decimal(18, 6)
  snapshotCustomsPaymentExchangeRate         Decimal?             @db.Decimal(18, 6)
  snapshotDealAmount_amount_original         Decimal?             @db.Decimal(14, 2)
  snapshotDealAmount_currency                Currency?
  snapshotDealAmount_exchange_rate           Decimal?             @db.Decimal(10, 4)
  snapshotDealAmount_amount_uzs              Decimal?             @db.Decimal(16, 2)
  snapshotDealAmount_exchange_source         ExchangeSource?
  snapshotCertificatePayment_amount_original Decimal?             @db.Decimal(14, 2)
  snapshotCertificatePayment_currency        Currency?
  snapshotCertificatePayment_exchange_rate   Decimal?             @db.Decimal(10, 4)
  snapshotCertificatePayment_amount_uzs      Decimal?             @db.Decimal(16, 2)
  snapshotCertificatePayment_exchange_source ExchangeSource?
  snapshotPsrPrice_amount_original           Decimal?             @db.Decimal(14, 2)
  snapshotPsrPrice_currency                  Currency?
  snapshotPsrPrice_exchange_rate             Decimal?             @db.Decimal(10, 4)
  snapshotPsrPrice_amount_uzs                Decimal?             @db.Decimal(16, 2)
  snapshotPsrPrice_exchange_source           ExchangeSource?
  snapshotWorkerPrice_amount_original        Decimal?             @db.Decimal(14, 2)
  snapshotWorkerPrice_currency               Currency?
  snapshotWorkerPrice_exchange_rate          Decimal?             @db.Decimal(10, 4)
  snapshotWorkerPrice_amount_uzs             Decimal?             @db.Decimal(16, 2)
  snapshotWorkerPrice_exchange_source        ExchangeSource?
  snapshotCustomsPayment_amount_original     Decimal?             @db.Decimal(14, 2)
  snapshotCustomsPayment_currency            Currency?
  snapshotCustomsPayment_exchange_rate       Decimal?             @db.Decimal(10, 4)
  snapshotCustomsPayment_amount_uzs          Decimal?             @db.Decimal(16, 2)
  snapshotCustomsPayment_exchange_source     ExchangeSource?
  qrToken                                    String?                @unique
  aiChecks                                   AiCheck[]
  invoice                                    Invoice?
  kpiLogs                                    KpiLog[]
  structuredDocuments                        StructuredDocument[]
  branch                                     Branch               @relation(fields: [branchId], references: [id])
  client                                     Client               @relation(fields: [clientId], references: [id])
  createdBy                                  User                 @relation("TaskCreatedBy", fields: [createdById], references: [id])
  updatedBy                                  User?                @relation("TaskUpdatedBy", fields: [updatedById], references: [id])
  documents                                  TaskDocument[]
  errors                                     TaskError[]
  stages                                     TaskStage[]
  versions                                   TaskVersion[]
  transactions                               Transaction[]

  @@index([status])
  @@index([branchId])
  @@index([clientId])
  @@index([createdAt])
  @@index([branchId, status])
  @@index([clientId, status])
  @@index([status, createdAt])
}

model TaskStage {
  id           Int         @id @default(autoincrement())
  taskId       Int
  name         String
  stageOrder   Int
  status       StageStatus @default(BOSHLANMAGAN)
  startedAt    DateTime?
  completedAt  DateTime?
  assignedToId Int?
  durationMin  Int?
  price        Decimal?    @db.Decimal(12, 2)
  createdAt    DateTime    @default(now())
  assignedTo   User?       @relation("StageAssignedTo", fields: [assignedToId], references: [id])
  task         Task        @relation(fields: [taskId], references: [id])
}

model TaskError {
  id                 Int             @id @default(autoincrement())
  taskId             Int
  stageName          String
  workerId           Int
  amount             Decimal         @db.Decimal(12, 2)
  comment            String?
  date               DateTime
  createdAt          DateTime        @default(now())
  createdById        Int
  currency           Currency?       @default(USD)
  exchangeRate       Decimal?        @db.Decimal(18, 6)
  convertedUzsAmount Decimal?        @db.Decimal(12, 2)
  amount_original    Decimal?        @db.Decimal(14, 2)
  currency_universal Currency?
  exchange_rate      Decimal?        @db.Decimal(10, 4)
  amount_uzs         Decimal?        @db.Decimal(16, 2)
  exchange_source    ExchangeSource?
  task               Task            @relation(fields: [taskId], references: [id])
  worker             User            @relation("TaskErrorWorker", fields: [workerId], references: [id])
  createdBy          User            @relation("TaskErrorCreatedBy", fields: [createdById], references: [id])
}

model Transaction {
  id                 Int             @id @default(autoincrement())
  type               TransactionType
  amount             Decimal         @db.Decimal(12, 2)
  currency           Currency        @default(USD)
  paymentMethod      PaymentMethod?
  comment            String?
  date               DateTime
  taskId             Int?
  clientId           Int?
  workerId           Int?
  expenseCategory    String?
  branchId           Int?
  createdAt          DateTime        @default(now())
  originalAmount     Decimal?        @db.Decimal(12, 2)
  originalCurrency   Currency?
  exchangeRate       Decimal?        @db.Decimal(18, 6)
  convertedUzsAmount Decimal?        @db.Decimal(12, 2)
  amount_original    Decimal?        @db.Decimal(14, 2)
  currency_universal Currency?
  exchange_rate      Decimal?        @db.Decimal(10, 4)
  amount_uzs         Decimal?        @db.Decimal(16, 2)
  exchange_source    ExchangeSource?
  branch             Branch?         @relation(fields: [branchId], references: [id])
  client             Client?         @relation("TransactionClient", fields: [clientId], references: [id])
  task               Task?           @relation(fields: [taskId], references: [id])
  worker             User?           @relation("TransactionWorker", fields: [workerId], references: [id])
}

model KpiConfig {
  id        Int      @id @default(autoincrement())
  stageName String   @unique
  price     Decimal  @default(0) @db.Decimal(12, 2)
  updatedAt DateTime @updatedAt
}

model KpiLog {
  id                 Int             @id @default(autoincrement())
  userId             Int
  taskId             Int
  stageName          String
  amount             Decimal         @db.Decimal(12, 2)
  createdAt          DateTime        @default(now())
  currency           Currency?       @default(USD)
  exchangeRate       Decimal?        @db.Decimal(18, 6)
  convertedUzsAmount Decimal?        @db.Decimal(12, 2)
  amount_original    Decimal?        @db.Decimal(14, 2)
  currency_universal Currency?
  exchange_rate      Decimal?        @db.Decimal(10, 4)
  amount_uzs         Decimal?        @db.Decimal(16, 2)
  exchange_source    ExchangeSource?
  task               Task            @relation(fields: [taskId], references: [id])
  user               User            @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String
  entity    String
  entityId  Int?
  payload   Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model TaskVersion {
  id            Int        @id @default(autoincrement())
  taskId        Int
  version       Int
  title         String
  status        TaskStatus
  comments      String?
  hasPsr        Boolean
  driverPhone   String?
  clientId      Int
  branchId      Int
  changedBy     Int
  changes       Json?
  createdAt     DateTime   @default(now())
  changedByUser User       @relation(fields: [changedBy], references: [id])
  task          Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, version])
  @@index([taskId])
}

model StatePayment {
  id                 Int      @id @default(autoincrement())
  branchId           Int
  certificatePayment Decimal  @default(0) @db.Decimal(12, 2)
  psrPrice           Decimal  @default(0) @db.Decimal(12, 2)
  workerPrice        Decimal  @default(0) @db.Decimal(12, 2)
  customsPayment     Decimal  @default(0) @db.Decimal(12, 2)
  certificatePayment_amount_original Decimal?        @db.Decimal(14, 2)
  certificatePayment_amount_uzs      Decimal?        @db.Decimal(16, 2)
  psrPrice_amount_original           Decimal?        @db.Decimal(14, 2)
  psrPrice_amount_uzs                Decimal?        @db.Decimal(16, 2)
  workerPrice_amount_original        Decimal?        @db.Decimal(14, 2)
  workerPrice_amount_uzs             Decimal?        @db.Decimal(16, 2)
  customsPayment_amount_original     Decimal?        @db.Decimal(14, 2)
  customsPayment_amount_uzs          Decimal?        @db.Decimal(16, 2)
  exchange_rate      Decimal?        @db.Decimal(10, 4)
  exchange_source    ExchangeSource? @default(CBU)
  currency           Currency @default(UZS)
  createdAt          DateTime @default(now())
  branch             Branch   @relation(fields: [branchId], references: [id])

  @@index([branchId, createdAt])
}

model BXMConfig {
  id        Int      @id @default(autoincrement())
  amount    Decimal  @default(34.4) @db.Decimal(12, 2)
  amountUsd Decimal? @db.Decimal(12, 2)
  amountUzs Decimal? @db.Decimal(16, 2)
  year      Int      @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Training {
  id          Int                @id @default(autoincrement())
  title       String
  description String?
  orderIndex  Int                @default(0)
  active      Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  exams       Exam[]
  materials   TrainingMaterial[]
  progress    TrainingProgress[]
  stages      TrainingStage[]
}

model TrainingStage {
  id          Int            @id @default(autoincrement())
  trainingId  Int
  title       String
  description String?
  orderIndex  Int            @default(0)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  training    Training       @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  steps       TrainingStep[]

  @@index([trainingId])
  @@index([trainingId, orderIndex])
}

model TrainingStep {
  id          Int                @id @default(autoincrement())
  stageId     Int
  title       String
  description String?
  orderIndex  Int                @default(0)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  isActive    Boolean            @default(true)
  exams       Exam[]
  progress    LessonProgress[]
  materials   TrainingMaterial[]
  stage       TrainingStage      @relation(fields: [stageId], references: [id], onDelete: Cascade)

  @@index([stageId])
  @@index([stageId, orderIndex])
}

model TrainingMaterial {
  id          Int           @id @default(autoincrement())
  stepId      Int?
  trainingId  Int?
  title       String
  content     String?
  type        MaterialType
  fileUrl     String?
  orderIndex  Int           @default(0)
  durationMin Int?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  step        TrainingStep? @relation(fields: [stepId], references: [id], onDelete: Cascade)
  training    Training?     @relation(fields: [trainingId], references: [id], onDelete: Cascade)

  @@index([stepId])
  @@index([trainingId])
}

model TrainingProgress {
  id              Int       @id @default(autoincrement())
  userId          Int
  trainingId      Int
  stageId         Int?
  stepId          Int?
  materialId      Int?
  completed       Boolean   @default(false)
  progressPercent Int       @default(0)
  lastAccessedAt  DateTime  @default(now())
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  training        Training  @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, trainingId])
  @@index([userId])
  @@index([trainingId])
  @@index([stageId])
  @@index([stepId])
}

model LessonProgress {
  id               Int          @id @default(autoincrement())
  userId           Int
  lessonId         Int
  status           LessonStatus @default(LOCKED)
  lastAttemptScore Int?
  completedAt      DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  lesson           TrainingStep @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@index([userId])
  @@index([lessonId])
  @@index([userId, status])
}

model Exam {
  id            Int            @id @default(autoincrement())
  trainingId    Int?
  title         String
  description   String?
  passingScore  Int            @default(80)
  timeLimitMin  Int?
  active        Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  lessonId      Int?
  questionCount Int?
  lesson        TrainingStep?  @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  training      Training?      @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  attempts      ExamAttempt[]
  questions     ExamQuestion[]

  @@index([trainingId])
  @@index([lessonId])
}

model ExamQuestion {
  id            Int          @id @default(autoincrement())
  examId        Int
  question      String
  type          QuestionType @default(SINGLE_CHOICE)
  options       Json
  correctAnswer Json
  points        Int          @default(1)
  orderIndex    Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  answers       ExamAnswer[]
  exam          Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@index([examId])
}

model ExamAttempt {
  id            Int          @id @default(autoincrement())
  userId        Int
  examId        Int
  score         Int          @default(0)
  maxScore      Int          @default(100)
  passed        Boolean      @default(false)
  startedAt     DateTime     @default(now())
  completedAt   DateTime?
  aiFeedback    Json?
  attemptNumber Int          @default(1)
  answers       ExamAnswer[]
  exam          Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  user          User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([examId])
  @@index([userId, examId])
  @@index([userId, completedAt])
}

model ExamAnswer {
  id         Int          @id @default(autoincrement())
  attemptId  Int
  questionId Int
  answer     Json
  isCorrect  Boolean      @default(false)
  points     Int          @default(0)
  createdAt  DateTime     @default(now())
  attempt    ExamAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question   ExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([questionId])
}

model ExchangeRate {
  id        Int            @id @default(autoincrement())
  currency  Currency       @default(USD)
  rate      Decimal        @db.Decimal(10, 4)
  date      DateTime
  source    ExchangeSource @default(CBU)
  createdAt DateTime       @default(now())

  @@unique([currency, date])
  @@index([currency])
  @@index([date])
}

model TaskDocument {
  id             Int                 @id @default(autoincrement())
  taskId         Int
  name           String
  fileUrl        String
  fileType       String
  fileSize       Int?
  description    String?
  documentType   DocumentType?
  uploadedById   Int
  createdAt      DateTime            @default(now())
  metadata       DocumentMetadata?
  structuredData StructuredDocument?
  task           Task                @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy     User                @relation("DocumentUploadedBy", fields: [uploadedById], references: [id])

  @@index([taskId])
  @@index([uploadedById])
  @@index([documentType])
}

model DocumentMetadata {
  id             Int          @id @default(autoincrement())
  taskDocumentId Int          @unique
  extractedText  String
  pageCount      Int?
  extractedAt    DateTime     @default(now())
  taskDocument   TaskDocument @relation(fields: [taskDocumentId], references: [id], onDelete: Cascade)

  @@index([taskDocumentId])
}

model StructuredDocument {
  id             Int          @id @default(autoincrement())
  taskDocumentId Int          @unique
  taskId         Int
  documentType   DocumentType
  structuredData Json
  extractedAt    DateTime     @default(now())
  taskDocument   TaskDocument @relation(fields: [taskDocumentId], references: [id], onDelete: Cascade)
  task           Task         @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([taskDocumentId])
  @@index([documentType])
}

model AiCheck {
  id        Int           @id @default(autoincrement())
  taskId    Int
  checkType AiCheckType
  result    AiCheckResult
  details   Json
  createdAt DateTime      @default(now())
  task      Task          @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([taskId])
  @@index([checkType])
  @@index([result])
  @@index([createdAt])
}

model ArchiveDocument {
  id                     Int      @id @default(autoincrement())
  taskId                 Int
  taskTitle              String
  clientName             String
  branchName             String
  name                   String
  fileUrl                String
  fileType               String
  fileSize               Int?
  description            String?
  uploadedById           Int
  archivedAt             DateTime @default(now())
  originalTaskDocumentId Int?
  uploadedBy             User     @relation("ArchiveDocumentUploadedBy", fields: [uploadedById], references: [id])

  @@index([taskId])
  @@index([uploadedById])
  @@index([archivedAt])
  @@index([clientName])
}

model AccountBalance {
  id        Int           @id @default(autoincrement())
  type      PaymentMethod
  balance   Decimal       @default(0) @db.Decimal(12, 2)
  currency  Currency      @default(USD)
  updatedAt DateTime      @updatedAt
  createdAt DateTime      @default(now())

  @@unique([type, currency])
  @@index([type])
}

model Debt {
  id                 Int             @id @default(autoincrement())
  debtorType         DebtorType
  debtorId           Int
  amount             Decimal         @db.Decimal(12, 2)
  currency           Currency        @default(USD)
  comment            String?
  date               DateTime
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  originalAmount     Decimal?        @db.Decimal(12, 2)
  originalCurrency   Currency?
  exchangeRate       Decimal?        @db.Decimal(18, 6)
  convertedUzsAmount Decimal?        @db.Decimal(12, 2)
  amount_original    Decimal?        @db.Decimal(14, 2)
  currency_universal Currency?
  exchange_rate      Decimal?        @db.Decimal(10, 4)
  amount_uzs         Decimal?        @db.Decimal(16, 2)
  exchange_source    ExchangeSource?

  @@index([debtorType, debtorId])
  @@index([date])
}

model PreviousYearWorkerDebt {
  id                          Int             @id @default(autoincrement())
  workerId                    Int
  totalEarned                 Decimal         @db.Decimal(12, 2)
  totalPaid                   Decimal         @db.Decimal(12, 2)
  balance                     Decimal         @db.Decimal(12, 2)
  currency                    Currency        @default(USD)
  year                        Int
  comment                     String?
  createdAt                   DateTime        @default(now())
  updatedAt                   DateTime        @updatedAt
  exchangeRate                Decimal?        @db.Decimal(18, 6)
  totalEarnedInUzs            Decimal?        @db.Decimal(12, 2)
  totalPaidInUzs              Decimal?        @db.Decimal(12, 2)
  balanceInUzs                Decimal?        @db.Decimal(12, 2)
  totalEarned_amount_original Decimal?        @db.Decimal(14, 2)
  totalPaid_amount_original   Decimal?        @db.Decimal(14, 2)
  balance_amount_original     Decimal?        @db.Decimal(14, 2)
  currency_universal          Currency?
  exchange_rate               Decimal?        @db.Decimal(10, 4)
  totalEarned_amount_uzs      Decimal?        @db.Decimal(16, 2)
  totalPaid_amount_uzs        Decimal?        @db.Decimal(16, 2)
  balance_amount_uzs          Decimal?        @db.Decimal(16, 2)
  exchange_source             ExchangeSource?
  worker                      User            @relation("PreviousYearWorkerDebt", fields: [workerId], references: [id])

  @@unique([workerId, year])
  @@index([workerId])
  @@index([year])
}

model WorkerPayment {
  id              Int      @id @default(autoincrement())
  workerId        Int
  earnedAmountUsd Decimal  @db.Decimal(14, 2)
  paidCurrency    Currency @default(USD)
  exchangeRate    Decimal? @db.Decimal(10, 4)
  paidAmountUzs   Decimal? @db.Decimal(16, 2)
  paidAmountUsd   Decimal  @db.Decimal(14, 2)
  paymentDate     DateTime @default(now())
  comment         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  worker          User     @relation("WorkerPayment", fields: [workerId], references: [id])

  @@index([workerId])
  @@index([paymentDate])
}

model Invoice {
  id                 Int             @id @default(autoincrement())
  invoiceNumber      String
  contractNumber     String?
  taskId             Int             @unique
  clientId           Int
  branchId           Int
  date               DateTime        @default(now())
  currency           Currency        @default(USD)
  totalAmount        Decimal         @db.Decimal(12, 2)
  notes              String?
  additionalInfo     Json?
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  contractId         Int?
  exchangeRate       Decimal?        @db.Decimal(18, 6)
  convertedUzsAmount Decimal?        @db.Decimal(12, 2)
  amount_original    Decimal?        @db.Decimal(14, 2)
  currency_universal Currency?
  exchange_rate      Decimal?        @db.Decimal(10, 4)
  amount_uzs         Decimal?        @db.Decimal(16, 2)
  exchange_source    ExchangeSource?
  branch             Branch          @relation(fields: [branchId], references: [id])
  client             Client          @relation(fields: [clientId], references: [id])
  contract           Contract?       @relation(fields: [contractId], references: [id])
  task               Task            @relation(fields: [taskId], references: [id], onDelete: Cascade)
  items              InvoiceItem[]

  @@index([clientId])
  @@index([taskId])
  @@index([invoiceNumber])
  @@index([contractId])
}

model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoiceId   Int
  tnvedCode   String?
  pluCode     String?
  name        String
  packageType String?
  unit        String
  quantity    Decimal  @db.Decimal(12, 2)
  grossWeight Decimal? @db.Decimal(12, 2)
  netWeight   Decimal? @db.Decimal(12, 2)
  unitPrice   Decimal  @db.Decimal(12, 2)
  totalPrice  Decimal  @db.Decimal(12, 2)
  orderIndex  Int      @default(0)
  createdAt   DateTime @default(now())
  invoice     Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId, orderIndex])
}

model Contract {
  id                             Int       @id @default(autoincrement())
  clientId                       Int
  contractNumber                 String
  contractDate                   DateTime
  sellerName                     String
  sellerLegalAddress             String
  sellerDetails                  String?
  sellerInn                      String?
  sellerOgrn                     String?
  sellerBankName                 String?
  sellerBankAddress              String?
  sellerBankAccount              String?
  sellerBankSwift                String?
  sellerCorrespondentBank        String?
  sellerCorrespondentBankAccount String?
  sellerCorrespondentBankSwift   String?
  buyerName                      String
  buyerAddress                   String
  destinationCountry             String?
  buyerDetails                   String?
  buyerInn                       String?
  buyerOgrn                      String?
  buyerBankName                  String?
  buyerBankAddress               String?
  buyerBankAccount               String?
  buyerBankSwift                 String?
  buyerCorrespondentBank         String?
  buyerCorrespondentBankAccount  String?
  buyerCorrespondentBankSwift    String?
  shipperName                    String?
  shipperAddress                 String?
  shipperDetails                 String?
  shipperInn                     String?
  shipperOgrn                    String?
  shipperBankName                String?
  shipperBankAddress             String?
  shipperBankAccount             String?
  shipperBankSwift               String?
  consigneeName                  String?
  consigneeAddress               String?
  consigneeDetails               String?
  consigneeInn                   String?
  consigneeOgrn                  String?
  consigneeBankName              String?
  consigneeBankAddress           String?
  consigneeBankAccount           String?
  consigneeBankSwift             String?
  deliveryTerms                  String?
  customsAddress                 String?
  paymentMethod                  String?
  gln                            String?
  supplierDirector               String?
  goodsReleasedBy                String?
  specification                  Json?     // Spetsifikatsiya: [{ productName, quantity, unit, unitPrice, totalPrice }]
  createdAt                      DateTime  @default(now())
  updatedAt                      DateTime  @updatedAt
  client                         Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  invoices                       Invoice[]

  @@index([clientId])
  @@index([contractNumber])
}

model CompanySettings {
  id                       Int      @id @unique @default(autoincrement())
  name                     String
  legalAddress             String
  actualAddress            String
  inn                      String?
  phone                    String?
  email                    String?
  bankName                 String?
  bankAddress              String?
  bankAccount              String?
  swiftCode                String?
  correspondentBank        String?
  correspondentBankAddress String?
  correspondentBankSwift   String?
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt
}

model CertifierFeeConfig {
  id        Int      @id @default(autoincrement())
  st1Rate   Decimal  @db.Decimal(12, 2)
  fitoRate  Decimal  @db.Decimal(12, 2)
  aktRate   Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model YearlyGoalConfig {
  id          Int      @id @default(autoincrement())
  year        Int      @unique
  targetTasks Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model CurrencyExchangeRate {
  id           Int      @id @default(autoincrement())
  fromCurrency Currency
  toCurrency   Currency
  rate         Decimal  @db.Decimal(18, 6)
  date         DateTime @default(now())
  source       String   @default("API")
  createdAt    DateTime @default(now())

  @@unique([fromCurrency, toCurrency, date])
  @@index([date])
  @@index([fromCurrency, toCurrency])
}

enum Role {
  ADMIN
  MANAGER
  DEKLARANT
  CERTIFICATE_WORKER
}

enum TaskStatus {
  BOSHLANMAGAN
  JARAYONDA
  TAYYOR
  TEKSHIRILGAN
  TOPSHIRILDI
  YAKUNLANDI
  INVOICE_READY
  ST_READY
  FITO_READY
  PASSED_AI_CHECK
  RETURNED
}

enum StageStatus {
  BOSHLANMAGAN
  TAYYOR
}

enum TransactionType {
  INCOME
  EXPENSE
  SALARY
}

enum PaymentMethod {
  CASH
  CARD
}

enum DebtorType {
  CLIENT
  WORKER
  CERTIFICATE_WORKER
  OTHER
}

enum MaterialType {
  TEXT
  AUDIO
  VIDEO
  IMAGE
}

enum QuestionType {
  SINGLE_CHOICE
  MULTIPLE_CHOICE
  TEXT
}

enum LessonStatus {
  NOT_STARTED
  LOCKED
  AVAILABLE
  IN_PROGRESS
  COMPLETED
  FAILED
}

enum Currency {
  USD
  UZS
}

enum ExchangeSource {
  CBU
  MANUAL
}

enum DocumentType {
  INVOICE
  ST
  FITO
  CMR
  OTHER
}

enum AiCheckType {
  INVOICE_ST
}

enum AiCheckResult {
  PASS
  FAIL
}

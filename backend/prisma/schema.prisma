generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Branch {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  tasks        Task[]
  transactions Transaction[]
  users        User[]
  statePayments StatePayment[]
}

model User {
  id           Int           @id @default(autoincrement())
  name         String
  email        String        @unique
  phone        String?
  role         Role
  position     String?
  salary       Decimal?      @db.Decimal(12, 2)
  branchId     Int?
  passwordHash String
  photoUrl     String?
  active       Boolean       @default(true)
  createdAt    DateTime      @default(now())
  auditLogs    AuditLog[]
  kpiLogs      KpiLog[]
  tasks        Task[]        @relation("TaskCreatedBy")
  updatedTasks Task[]         @relation("TaskUpdatedBy")
  taskErrors   TaskError[]
  stages       TaskStage[]   @relation("StageAssignedTo")
  transactions Transaction[] @relation("TransactionWorker")
  taskVersions TaskVersion[]
  branch       Branch?       @relation(fields: [branchId], references: [id])
}

model Client {
  id           Int           @id @default(autoincrement())
  name         String
  dealAmount   Decimal?      @db.Decimal(12, 2)
  phone        String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  tasks        Task[]
  transactions Transaction[] @relation("TransactionClient")
}

model Task {
  id           Int           @id @default(autoincrement())
  clientId     Int
  branchId     Int
  title        String
  status       TaskStatus    @default(BOSHLANMAGAN)
  createdById  Int
  updatedById  Int?
  comments     String?
  hasPsr       Boolean       @default(false)
  driverPhone  String?
  snapshotDealAmount Decimal? @db.Decimal(12, 2)  // Task yaratilgan vaqtdagi kelishuv summasi (snapshot)
  snapshotCertificatePayment Decimal? @db.Decimal(12, 2)  // Task yaratilgan vaqtdagi sertifikat to'lovi (snapshot)
  snapshotPsrPrice Decimal? @db.Decimal(12, 2)  // Task yaratilgan vaqtdagi PSR narxi (snapshot)
  snapshotWorkerPrice Decimal? @db.Decimal(12, 2)  // Task yaratilgan vaqtdagi ishchi narxi (snapshot)
  snapshotCustomsPayment Decimal? @db.Decimal(12, 2)  // Task yaratilgan vaqtdagi bojxona to'lovi (snapshot)
  customsPaymentMultiplier Decimal? @db.Decimal(5, 2)  // Deklaratsiya jarayonida tanlangan BXM multiplier (0.5 dan 4 gacha)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  kpiLogs      KpiLog[]
  branch       Branch        @relation(fields: [branchId], references: [id])
  client       Client        @relation(fields: [clientId], references: [id])
  createdBy    User          @relation("TaskCreatedBy", fields: [createdById], references: [id])
  updatedBy    User?         @relation("TaskUpdatedBy", fields: [updatedById], references: [id])
  errors       TaskError[]
  stages       TaskStage[]
  transactions Transaction[]
  versions     TaskVersion[]
}

model TaskStage {
  id           Int         @id @default(autoincrement())
  taskId       Int
  name         String
  stageOrder   Int
  status       StageStatus @default(BOSHLANMAGAN)
  startedAt    DateTime?
  completedAt  DateTime?
  assignedToId Int?
  durationMin  Int?
  price        Decimal?    @db.Decimal(12, 2)
  createdAt    DateTime    @default(now())
  assignedTo   User?       @relation("StageAssignedTo", fields: [assignedToId], references: [id])
  task         Task        @relation(fields: [taskId], references: [id])
}

model TaskError {
  id        Int      @id @default(autoincrement())
  taskId    Int
  stageName String
  workerId  Int
  amount    Decimal  @db.Decimal(12, 2)
  comment   String?
  date      DateTime
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id])
  worker    User     @relation(fields: [workerId], references: [id])
}

model Transaction {
  id              Int             @id @default(autoincrement())
  type            TransactionType
  amount          Decimal         @db.Decimal(12, 2)
  currency        String          @default("USD")
  comment         String?
  date            DateTime
  taskId          Int?
  clientId        Int?
  workerId        Int?
  expenseCategory String?
  branchId        Int?
  createdAt       DateTime        @default(now())
  branch          Branch?         @relation(fields: [branchId], references: [id])
  client          Client?         @relation("TransactionClient", fields: [clientId], references: [id])
  task            Task?           @relation(fields: [taskId], references: [id])
  worker          User?           @relation("TransactionWorker", fields: [workerId], references: [id])
}

model KpiConfig {
  id        Int      @id @default(autoincrement())
  stageName String   @unique
  price     Decimal  @default(0) @db.Decimal(12, 2)
  updatedAt DateTime @updatedAt
}

model KpiLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  taskId    Int
  stageName String
  amount    Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String
  entity    String
  entityId  Int?
  payload   Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model TaskVersion {
  id           Int      @id @default(autoincrement())
  taskId       Int
  version      Int
  title        String
  status       TaskStatus
  comments     String?
  hasPsr       Boolean
  driverPhone  String?
  clientId     Int
  branchId     Int
  changedBy    Int
  changes      Json?    // O'zgarishlar haqida ma'lumot
  createdAt    DateTime @default(now())
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  changedByUser User    @relation(fields: [changedBy], references: [id])
  
  @@unique([taskId, version])
  @@index([taskId])
}

model StatePayment {
  id                Int      @id @default(autoincrement())
  branchId          Int      // Har bir filial uchun bir nechta davlat to'lovi bo'lishi mumkin
  certificatePayment Decimal @default(0) @db.Decimal(12, 2)  // Sertifikat to'lovi
  psrPrice          Decimal  @default(0) @db.Decimal(12, 2)  // PSR narxi
  workerPrice       Decimal  @default(0) @db.Decimal(12, 2)  // Ishchi narxi
  customsPayment    Decimal  @default(0) @db.Decimal(12, 2)  // Bojxona to'lovi
  createdAt         DateTime @default(now())  // Bu davlat to'lovi qachon yaratilgan (shu vaqtdan boshlab amal qiladi)
  branch            Branch   @relation(fields: [branchId], references: [id])
  
  @@index([branchId, createdAt])
}

model BXMConfig {
  id        Int      @id @default(autoincrement())
  amount    Decimal  @default(34.4) @db.Decimal(12, 2)  // Bazaviy Xisoblash Miqdori (BXM)
  year      Int      @unique  // Yil (har yil uchun alohida BXM)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  ADMIN
  MANAGER
  DEKLARANT
}

enum TaskStatus {
  BOSHLANMAGAN
  JARAYONDA
  TAYYOR
  TEKSHIRILGAN
  TOPSHIRILDI
  YAKUNLANDI
}

enum StageStatus {
  BOSHLANMAGAN
  TAYYOR
}

enum TransactionType {
  INCOME
  EXPENSE
  SALARY
}

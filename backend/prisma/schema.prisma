generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Branch {
  id            Int            @id @default(autoincrement())
  name          String         @unique
  tasks         Task[]
  transactions  Transaction[]
  users         User[]
  statePayments StatePayment[]
  invoices      Invoice[]
}

model User {
  id               Int                @id @default(autoincrement())
  name             String
  email            String             @unique
  phone            String?
  role             Role
  position         String?
  salary           Decimal?           @db.Decimal(12, 2)
  branchId         Int?
  passwordHash     String
  photoUrl         String?
  active           Boolean            @default(true)
  createdAt        DateTime           @default(now())
  auditLogs        AuditLog[]
  kpiLogs          KpiLog[]
  tasks            Task[]             @relation("TaskCreatedBy")
  updatedTasks     Task[]             @relation("TaskUpdatedBy")
  taskErrors       TaskError[]
  stages           TaskStage[]        @relation("StageAssignedTo")
  transactions     Transaction[]      @relation("TransactionWorker")
  taskVersions     TaskVersion[]
  trainingProgress TrainingProgress[]
  examAttempts     ExamAttempt[]
  taskDocuments    TaskDocument[]     @relation("DocumentUploadedBy")
  archiveDocuments ArchiveDocument[]  @relation("ArchiveDocumentUploadedBy")
  branch           Branch?            @relation(fields: [branchId], references: [id])
}

model Client {
  id                       Int           @id @default(autoincrement())
  name                     String
  dealAmount               Decimal?      @db.Decimal(12, 2)
  dealAmountCurrency       Currency?     @default(USD) // Shartnoma valyutasi
  phone                    String?
  passwordHash             String?
  creditType               String? // 'TASK_COUNT' yoki 'AMOUNT' - nasiya turi
  creditLimit              Decimal?      @db.Decimal(12, 2) // Nasiya limiti (ish soni yoki summa)
  creditStartDate          DateTime? // Nasiya boshlangan sana
  // Shartnoma ma'lumotlari (Invoice uchun)
  contractNumber           String? // Shartnoma raqami (masalan: "RVI-FER-291019")
  address                  String? // Адрес (Покупатель)
  inn                      String? // ИНН
  email                    String? // E-mail
  bankName                 String? // Банк получателя
  bankAddress              String? // Адрес банка
  bankAccount              String? // Текущий счет
  transitAccount           String? // Транзитный счет
  bankSwift                String? // SWIFT
  correspondentBank        String? // Наименование банка корреспондента
  correspondentBankAccount String? // Кор счет
  correspondentBankSwift   String? // SWIFT банка-корреспондента
  createdAt                DateTime      @default(now())
  updatedAt                DateTime      @updatedAt
  tasks                    Task[]
  transactions             Transaction[] @relation("TransactionClient")
  invoices                 Invoice[]
  contracts                Contract[]
}

model Task {
  id                         Int            @id @default(autoincrement())
  clientId                   Int
  branchId                   Int
  title                      String
  status                     TaskStatus     @default(BOSHLANMAGAN)
  createdById                Int
  updatedById                Int?
  comments                   String?
  hasPsr                     Boolean        @default(false)
  driverPhone                String?
  snapshotDealAmount         Decimal?       @db.Decimal(12, 2) // Task yaratilgan vaqtdagi kelishuv summasi (snapshot)
  snapshotCertificatePayment Decimal?       @db.Decimal(12, 2) // Task yaratilgan vaqtdagi sertifikat to'lovi (snapshot)
  snapshotPsrPrice           Decimal?       @db.Decimal(12, 2) // Task yaratilgan vaqtdagi PSR narxi (snapshot)
  snapshotWorkerPrice        Decimal?       @db.Decimal(12, 2) // Task yaratilgan vaqtdagi ishchi narxi (snapshot)
  snapshotCustomsPayment     Decimal?       @db.Decimal(12, 2) // Task yaratilgan vaqtdagi bojxona to'lovi (snapshot)
  customsPaymentMultiplier   Decimal?       @db.Decimal(5, 2) // Deklaratsiya jarayonida tanlangan BXM multiplier (0.5 dan 4 gacha)
  createdAt                  DateTime       @default(now())
  updatedAt                  DateTime       @updatedAt
  kpiLogs                    KpiLog[]
  branch                     Branch         @relation(fields: [branchId], references: [id])
  client                     Client         @relation(fields: [clientId], references: [id])
  createdBy                  User           @relation("TaskCreatedBy", fields: [createdById], references: [id])
  updatedBy                  User?          @relation("TaskUpdatedBy", fields: [updatedById], references: [id])
  errors                     TaskError[]
  stages                     TaskStage[]
  transactions               Transaction[]
  versions                   TaskVersion[]
  documents                  TaskDocument[]
  invoice                    Invoice?
}

model TaskStage {
  id           Int         @id @default(autoincrement())
  taskId       Int
  name         String
  stageOrder   Int
  status       StageStatus @default(BOSHLANMAGAN)
  startedAt    DateTime?
  completedAt  DateTime?
  assignedToId Int?
  durationMin  Int?
  price        Decimal?    @db.Decimal(12, 2)
  createdAt    DateTime    @default(now())
  assignedTo   User?       @relation("StageAssignedTo", fields: [assignedToId], references: [id])
  task         Task        @relation(fields: [taskId], references: [id])
}

model TaskError {
  id        Int      @id @default(autoincrement())
  taskId    Int
  stageName String
  workerId  Int
  amount    Decimal  @db.Decimal(12, 2)
  comment   String?
  date      DateTime
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id])
  worker    User     @relation(fields: [workerId], references: [id])
}

model Transaction {
  id              Int             @id @default(autoincrement())
  type            TransactionType
  amount          Decimal         @db.Decimal(12, 2)
  currency        Currency        @default(USD) // Majburiy valyuta
  paymentMethod   PaymentMethod? // Naqt yoki karta
  comment         String?
  date            DateTime
  taskId          Int?
  clientId        Int?
  workerId        Int?
  expenseCategory String?
  branchId        Int?
  createdAt       DateTime        @default(now())
  branch          Branch?         @relation(fields: [branchId], references: [id])
  client          Client?         @relation("TransactionClient", fields: [clientId], references: [id])
  task            Task?           @relation(fields: [taskId], references: [id])
  worker          User?           @relation("TransactionWorker", fields: [workerId], references: [id])
}

model KpiConfig {
  id        Int      @id @default(autoincrement())
  stageName String   @unique
  price     Decimal  @default(0) @db.Decimal(12, 2)
  updatedAt DateTime @updatedAt
}

model KpiLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  taskId    Int
  stageName String
  amount    Decimal  @db.Decimal(12, 2)
  createdAt DateTime @default(now())
  task      Task     @relation(fields: [taskId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  userId    Int?
  action    String
  entity    String
  entityId  Int?
  payload   Json?
  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
}

model TaskVersion {
  id            Int        @id @default(autoincrement())
  taskId        Int
  version       Int
  title         String
  status        TaskStatus
  comments      String?
  hasPsr        Boolean
  driverPhone   String?
  clientId      Int
  branchId      Int
  changedBy     Int
  changes       Json? // O'zgarishlar haqida ma'lumot
  createdAt     DateTime   @default(now())
  task          Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  changedByUser User       @relation(fields: [changedBy], references: [id])

  @@unique([taskId, version])
  @@index([taskId])
}

model StatePayment {
  id                 Int      @id @default(autoincrement())
  branchId           Int // Har bir filial uchun bir nechta davlat to'lovi bo'lishi mumkin
  certificatePayment Decimal  @default(0) @db.Decimal(12, 2) // Sertifikat to'lovi
  psrPrice           Decimal  @default(0) @db.Decimal(12, 2) // PSR narxi
  workerPrice        Decimal  @default(0) @db.Decimal(12, 2) // Ishchi narxi
  customsPayment     Decimal  @default(0) @db.Decimal(12, 2) // Bojxona to'lovi
  currency           Currency @default(UZS) // Davlat to'lovlari UZSda
  createdAt          DateTime @default(now()) // Bu davlat to'lovi qachon yaratilgan (shu vaqtdan boshlab amal qiladi)
  branch             Branch   @relation(fields: [branchId], references: [id])

  @@index([branchId, createdAt])
}

model BXMConfig {
  id        Int      @id @default(autoincrement())
  amount    Decimal  @default(34.4) @db.Decimal(12, 2) // Bazaviy Xisoblash Miqdori (BXM)
  year      Int      @unique // Yil (har yil uchun alohida BXM)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum Role {
  ADMIN
  MANAGER
  DEKLARANT
  CERTIFICATE_WORKER
}

enum TaskStatus {
  BOSHLANMAGAN
  JARAYONDA
  TAYYOR
  TEKSHIRILGAN
  TOPSHIRILDI
  YAKUNLANDI
}

enum StageStatus {
  BOSHLANMAGAN
  TAYYOR
}

enum TransactionType {
  INCOME
  EXPENSE
  SALARY
}

enum PaymentMethod {
  CASH
  CARD
}

enum DebtorType {
  CLIENT
  WORKER
  CERTIFICATE_WORKER
  OTHER
}

// O'qitish tizimi modellari
model Training {
  id          Int                @id @default(autoincrement())
  title       String
  description String?
  orderIndex  Int                @default(0) // Tartib raqami
  active      Boolean            @default(true)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  stages      TrainingStage[]
  progress    TrainingProgress[]
  exams       Exam[]
  // Eski materiallar (backward compatibility)
  materials   TrainingMaterial[]
}

// Bosqichlar (masalan: "1. KOMPANIYA BILAN TANISHUV")
model TrainingStage {
  id          Int            @id @default(autoincrement())
  trainingId  Int
  title       String // "1. KOMPANIYA BILAN TANISHUV"
  description String?
  orderIndex  Int            @default(0) // Tartib raqami
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  training    Training       @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  steps       TrainingStep[]

  @@index([trainingId])
  @@index([trainingId, orderIndex])
}

// Qadamlar (masalan: "1. KOMPANIYA HAQIDA QISQACHA", "2. BIZ UCHUN ENG MUHIM TAMOYILLAR")
model TrainingStep {
  id          Int                @id @default(autoincrement())
  stageId     Int
  title       String // "1. KOMPANIYA HAQIDA QISQACHA"
  description String?
  orderIndex  Int                @default(0) // Tartib raqami
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  stage       TrainingStage      @relation(fields: [stageId], references: [id], onDelete: Cascade)
  materials   TrainingMaterial[]

  @@index([stageId])
  @@index([stageId, orderIndex])
}

// Materiallar (har bir qadam ichida)
model TrainingMaterial {
  id          Int           @id @default(autoincrement())
  stepId      Int? // Yangi: qadamga bog'langan
  trainingId  Int? // Eski: backward compatibility
  title       String
  content     String? // Matn kontenti
  type        MaterialType
  fileUrl     String? // Audio yoki Video fayl URL
  orderIndex  Int           @default(0) // Tartib raqami
  durationMin Int? // Video/Audio davomiyligi (daqiqa)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  step        TrainingStep? @relation(fields: [stepId], references: [id], onDelete: Cascade)
  training    Training?     @relation(fields: [trainingId], references: [id], onDelete: Cascade)

  @@index([stepId])
  @@index([trainingId])
}

model TrainingProgress {
  id              Int       @id @default(autoincrement())
  userId          Int
  trainingId      Int
  stageId         Int? // Qaysi bosqichni o'qigan
  stepId          Int? // Qaysi qadamni o'qigan
  materialId      Int? // Qaysi materialni o'qigan (backward compatibility)
  completed       Boolean   @default(false)
  progressPercent Int       @default(0) // 0-100%
  lastAccessedAt  DateTime  @default(now())
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  training        Training  @relation(fields: [trainingId], references: [id], onDelete: Cascade)

  @@unique([userId, trainingId])
  @@index([userId])
  @@index([trainingId])
  @@index([stageId])
  @@index([stepId])
}

model Exam {
  id           Int            @id @default(autoincrement())
  trainingId   Int
  title        String
  description  String?
  passingScore Int            @default(70) // O'tish balli (foiz)
  timeLimitMin Int? // Vaqt cheklovi (daqiqa)
  active       Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  training     Training       @relation(fields: [trainingId], references: [id], onDelete: Cascade)
  questions    ExamQuestion[]
  attempts     ExamAttempt[]

  @@index([trainingId])
}

model ExamQuestion {
  id            Int          @id @default(autoincrement())
  examId        Int
  question      String
  type          QuestionType @default(SINGLE_CHOICE)
  options       Json // Variantlar: ["A", "B", "C", "D"]
  correctAnswer Json // To'g'ri javob
  points        Int          @default(1) // Ball
  orderIndex    Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  exam          Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)
  answers       ExamAnswer[]

  @@index([examId])
}

model ExamAttempt {
  id          Int          @id @default(autoincrement())
  userId      Int
  examId      Int
  score       Int          @default(0) // Olingan ball
  maxScore    Int // Maksimal ball
  passed      Boolean      @default(false)
  startedAt   DateTime     @default(now())
  completedAt DateTime?
  answers     ExamAnswer[]
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  exam        Exam         @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([examId])
}

model ExamAnswer {
  id         Int          @id @default(autoincrement())
  attemptId  Int
  questionId Int
  answer     Json // Foydalanuvchi javobi
  isCorrect  Boolean      @default(false)
  points     Int          @default(0)
  createdAt  DateTime     @default(now())
  attempt    ExamAttempt  @relation(fields: [attemptId], references: [id], onDelete: Cascade)
  question   ExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([attemptId])
  @@index([questionId])
}

enum MaterialType {
  TEXT
  AUDIO
  VIDEO
  IMAGE
}

enum QuestionType {
  SINGLE_CHOICE // Bitta javob tanlash
  MULTIPLE_CHOICE // Bir nechta javob tanlash
  TEXT // Matnli javob
}

enum Currency {
  USD
  UZS
}

// Valyuta kurslari
model CurrencyExchangeRate {
  id           Int      @id @default(autoincrement())
  fromCurrency Currency
  toCurrency   Currency
  rate         Decimal  @db.Decimal(18, 6) // Kurs (masalan, 1 USD = 12500 UZS)
  date         DateTime @default(now()) // Kurs sanasi
  source       String   @default("API") // MANUAL yoki API
  createdAt    DateTime @default(now())

  @@unique([fromCurrency, toCurrency, date])
  @@index([fromCurrency, toCurrency])
  @@index([date])
}

// Hujjatlar aylanmasi
model TaskDocument {
  id           Int      @id @default(autoincrement())
  taskId       Int
  name         String // Hujjat nomi
  fileUrl      String // Fayl URL
  fileType     String // Fayl turi (image, video, audio, document, pdf, etc.)
  fileSize     Int? // Fayl hajmi (bytes)
  description  String? // Hujjat tavsifi
  uploadedById Int // Kim yuklagan
  createdAt    DateTime @default(now())
  task         Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  uploadedBy   User     @relation("DocumentUploadedBy", fields: [uploadedById], references: [id])

  @@index([taskId])
  @@index([uploadedById])
}

model ArchiveDocument {
  id                     Int      @id @default(autoincrement())
  taskId                 Int // Yakunlangan task ID
  taskTitle              String // Task nomi (snapshot)
  clientName             String // Client nomi (snapshot)
  branchName             String // Filial nomi (snapshot)
  name                   String // Hujjat nomi
  fileUrl                String // Fayl URL
  fileType               String // Fayl turi
  fileSize               Int? // Fayl hajmi (bytes)
  description            String? // Hujjat tavsifi
  uploadedById           Int // Kim yuklagan
  archivedAt             DateTime @default(now()) // Qachon arxivga ko'chirilgan
  originalTaskDocumentId Int? // Original TaskDocument ID (reference)
  uploadedBy             User     @relation("ArchiveDocumentUploadedBy", fields: [uploadedById], references: [id])

  @@index([taskId])
  @@index([uploadedById])
  @@index([archivedAt])
  @@index([clientName])
}

// Pul nazorati modellari
model AccountBalance {
  id        Int           @id @default(autoincrement())
  type      PaymentMethod // CASH yoki CARD
  balance   Decimal       @default(0) @db.Decimal(12, 2)
  currency  Currency      @default(USD)
  updatedAt DateTime      @updatedAt
  createdAt DateTime      @default(now())

  @@unique([type, currency])
  @@index([type])
}

model Debt {
  id         Int        @id @default(autoincrement())
  debtorType DebtorType // CLIENT, WORKER, CERTIFICATE_WORKER, OTHER
  debtorId   Int // Qarzdorning ID (clientId, userId yoki boshqa)
  amount     Decimal    @db.Decimal(12, 2)
  currency   Currency   @default(USD) // Majburiy valyuta
  comment    String?
  date       DateTime
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([debtorType, debtorId])
  @@index([date])
}

// Invoice modellari
model Invoice {
  id             Int      @id @default(autoincrement())
  invoiceNumber  String   @unique // "49" yoki avtomatik generatsiya
  contractNumber String? // Shartnoma raqami (masalan: "RVI-FER-291019")
  taskId         Int      @unique // Qaysi task uchun
  clientId       Int
  branchId       Int
  date           DateTime @default(now()) // Invoice sanasi
  currency       Currency @default(USD)
  totalAmount    Decimal  @db.Decimal(12, 2)
  notes          String? // "Особые примечания"
  additionalInfo Json? // Дополнительная информация (JSON formatida)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  task       Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  client     Client    @relation(fields: [clientId], references: [id])
  branch     Branch    @relation(fields: [branchId], references: [id])
  contractId Int?
  contract   Contract? @relation(fields: [contractId], references: [id])

  items InvoiceItem[]

  @@index([clientId])
  @@index([taskId])
  @@index([invoiceNumber])
  @@index([contractId])
}

model InvoiceItem {
  id          Int      @id @default(autoincrement())
  invoiceId   Int
  tnvedCode   String? // Код ТН ВЭД
  pluCode     String? // Код PLU
  name        String // Наименование товара
  packageType String? // Вид упаковки
  unit        String // Ед. изм. (кг, шт, etc.)
  quantity    Decimal  @db.Decimal(12, 2) // Мест
  grossWeight Decimal? @db.Decimal(12, 2) // Брутто (кг)
  netWeight   Decimal? @db.Decimal(12, 2) // Нетто (кг)
  unitPrice   Decimal  @db.Decimal(12, 2) // Цена за ед.изм.
  totalPrice  Decimal  @db.Decimal(12, 2) // Сумма с НДС
  orderIndex  Int      @default(0) // Tartib raqami
  createdAt   DateTime @default(now())

  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([invoiceId, orderIndex])
}

// Shartnoma modellari
model Contract {
  id             Int      @id @default(autoincrement())
  clientId       Int
  contractNumber String
  contractDate   DateTime

  // Sotuvchi ma'lumotlari
  sellerName                     String
  sellerLegalAddress             String
  sellerDetails                  String? // To'g'ridan-to'g'ri textarea ma'lumotlari (INN, OGRN, bank va boshqa rekvizitlar)
  sellerInn                      String?
  sellerOgrn                     String?
  sellerBankName                 String?
  sellerBankAddress              String?
  sellerBankAccount              String?
  sellerBankSwift                String?
  sellerCorrespondentBank        String?
  sellerCorrespondentBankAccount String?
  sellerCorrespondentBankSwift   String?

  // Sotib oluvchi ma'lumotlari
  buyerName                     String
  buyerAddress                  String
  buyerDetails                  String? // To'g'ridan-to'g'ri textarea ma'lumotlari (INN, OGRN, bank va boshqa rekvizitlar)
  buyerInn                      String?
  buyerOgrn                     String?
  buyerBankName                 String?
  buyerBankAddress              String?
  buyerBankAccount              String?
  buyerBankSwift                String?
  buyerCorrespondentBank        String?
  buyerCorrespondentBankAccount String?
  buyerCorrespondentBankSwift   String?

  // Yuk jo'natuvchi (ixtiyoriy)
  shipperName        String?
  shipperAddress     String?
  shipperDetails     String? // To'g'ridan-to'g'ri textarea ma'lumotlari (INN, OGRN, bank va boshqa rekvizitlar)
  shipperInn         String?
  shipperOgrn        String?
  shipperBankName    String?
  shipperBankAddress String?
  shipperBankAccount String?
  shipperBankSwift   String?

  // Yuk qabul qiluvchi (ixtiyoriy)
  consigneeName        String?
  consigneeAddress     String?
  consigneeDetails     String? // To'g'ridan-to'g'ri textarea ma'lumotlari (INN, OGRN, bank va boshqa rekvizitlar)
  consigneeInn         String?
  consigneeOgrn        String?
  consigneeBankName    String?
  consigneeBankAddress String?
  consigneeBankAccount String?
  consigneeBankSwift   String?

  // Qo'shimcha ma'lumotlar
  deliveryTerms String? // Yetkazib berish sharti
  paymentMethod String? // To'lov usuli
  gln          String? // Глобальный идентификационный номер GS1 (GLN)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  client   Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  invoices Invoice[]

  @@index([clientId])
  @@index([contractNumber])
}

// Kompaniya sozlamalari (Invoice uchun)
model CompanySettings {
  id                       Int      @id @default(autoincrement())
  name                     String // "ООО "FERGANA EXIM AGRO""
  legalAddress             String // Юридический адрес
  actualAddress            String // Фактический адрес
  inn                      String? // ИНН
  phone                    String?
  email                    String?
  bankName                 String? // Банк nomi
  bankAddress              String? // Адрес банка
  bankAccount              String? // Номер счета
  swiftCode                String? // SWIFT
  correspondentBank        String? // Банк-корреспондент
  correspondentBankAddress String? // Адрес банка-корреспондента
  correspondentBankSwift   String? // SWIFT банка-корреспондента
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  @@unique([id]) // Faqat bitta sozlama bo'lishi kerak
}
